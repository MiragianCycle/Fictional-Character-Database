{% extends "base.html" %}

{% block content %}
    <h1>{{ character.name }}</h1>
    <p>{{ character.description }}</p>
    
    <a href="{{ url_for('edit_character', id=character.id) }}" class="button">Edit Character</a>
    
    <form method="POST" action="{{ url_for('delete_character', id=character.id) }}" onsubmit="return confirm('Are you sure you want to delete this character?');" style="display: inline;">
        <button type="submit" style="background-color: #e74c3c;">Delete Character</button>
    </form>

    <h2>Character Arc</h2>
    {% if arc %}
        <div class="character">
            <p>Act 1 - Self Esteem: {{ arc.act1_self_esteem }}, Social Reputation: {{ arc.act1_social_reputation }}, Psychological Index: {{ arc.act1_psychological_index }}</p>
            <p>Act 2 - Self Esteem: {{ arc.act2_self_esteem }}, Social Reputation: {{ arc.act2_social_reputation }}, Psychological Index: {{ arc.act2_psychological_index }}</p>
            <p>Act 3 - Self Esteem: {{ arc.act3_self_esteem }}, Social Reputation: {{ arc.act3_social_reputation }}, Psychological Index: {{ arc.act3_psychological_index }}</p>
        </div>
        
        <h3>Psychological Index Chart</h3>
        <canvas id="arcChart" width="400" height="200"></canvas>
        
        <script>
        fetch('/character/{{ character.id }}/arc_data')
            .then(response => response.json())
            .then(data => {
                const ctx = document.getElementById('arcChart').getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            label: 'Psychological Index',
                            data: data.psychological_index,
                            borderColor: 'rgb(75, 192, 192)',
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            });
        </script>

        <h3>Edit Character Arc</h3>
        <form method="POST" action="{{ url_for('edit_character_arc', id=character.id) }}">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <label>Act 1 - Self Esteem: <input type="number" name="act1_self_esteem" min="0" max="5" step="0.1" required value="{{ arc.act1_self_esteem }}"></label>
                <label>Act 1 - Social Reputation: <input type="number" name="act1_social_reputation" min="0" max="5" step="0.1" required value="{{ arc.act1_social_reputation }}"></label>
                <label>Act 2 - Self Esteem: <input type="number" name="act2_self_esteem" min="0" max="5" step="0.1" required value="{{ arc.act2_self_esteem }}"></label>
                <label>Act 2 - Social Reputation: <input type="number" name="act2_social_reputation" min="0" max="5" step="0.1" required value="{{ arc.act2_social_reputation }}"></label>
                <label>Act 3 - Self Esteem: <input type="number" name="act3_self_esteem" min="0" max="5" step="0.1" required value="{{ arc.act3_self_esteem }}"></label>
                <label>Act 3 - Social Reputation: <input type="number" name="act3_social_reputation" min="0" max="5" step="0.1" required value="{{ arc.act3_social_reputation }}"></label>
            </div>
            <button type="submit">Update Arc</button>
        </form>
    {% else %}
        <h3>Add Character Arc</h3>
        <form method="POST" action="{{ url_for('add_character_arc', id=character.id) }}">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <label>Act 1 - Self Esteem: <input type="number" name="act1_self_esteem" min="0" max="5" step="0.1" required></label>
                <label>Act 1 - Social Reputation: <input type="number" name="act1_social_reputation" min="0" max="5" step="0.1" required></label>
                <label>Act 2 - Self Esteem: <input type="number" name="act2_self_esteem" min="0" max="5" step="0.1" required></label>
                <label>Act 2 - Social Reputation: <input type="number" name="act2_social_reputation" min="0" max="5" step="0.1" required></label>
                <label>Act 3 - Self Esteem: <input type="number" name="act3_self_esteem" min="0" max="5" step="0.1" required></label>
                <label>Act 3 - Social Reputation: <input type="number" name="act3_social_reputation" min="0" max="5" step="0.1" required></label>
            </div>
            <button type="submit">Add Arc</button>
        </form>
    {% endif %}

    <h2>Character Relationships</h2>
    {% if relationships %}
        <ul>
        {% for relationship in relationships %}
            <li>
                {% if relationship.character_from_id == character.id %}
                    {{ relationship.character_to.name }} ({{ relationship.relationship_type }}) - Intensity: {{ relationship.intensity }}
                {% else %}
                    {{ relationship.character_from.name }} ({{ relationship.relationship_type }}) - Intensity: {{ relationship.intensity }}
                {% endif %}
            </li>
        {% endfor %}
        </ul>
    {% else %}
        <p>No relationships defined yet.</p>
    {% endif %}

    <h3>Add Relationship</h3>
    <form method="POST" action="{{ url_for('add_relationship', id=character.id) }}">
        <label>
            Character:
            <select name="character_to_id" required>
                {% for other_character in characters if other_character.id != character.id %}
                    <option value="{{ other_character.id }}">{{ other_character.name }}</option>
                {% endfor %}
            </select>
        </label>
        <label>
            Relationship Type:
            <input type="text" name="relationship_type" required>
        </label>
        <label>
            Intensity (1-10):
            <input type="number" name="intensity" min="1" max="10" required>
        </label>
        <button type="submit">Add Relationship</button>
    </form>
{% endblock %}
